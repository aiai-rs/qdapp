<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f1621">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>汇盈国际加密专线</title>
    
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        tg: { bg: "#0f1621", header: "#17212b", input: "#0e1621", blue: "#2b5278", secondary: "#182533", accent: "#0088cc", danger: "#ff5252" },
                        login: { bg: "#0b1016", input: "#161e29" }
                    },
                    animation: { 'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'slide-up': 'slideUp 0.3s ease-out forwards' },
                    keyframes: { slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } } }
                }
            }
        }
    </script>
    <style>
        /* 强制全屏适配 */
        html, body { height: 100dvh; width: 100%; overflow: hidden; background-color: #0f1621; user-select: none; -webkit-tap-highlight-color: transparent; }
        #root { height: 100%; display: flex; flex-direction: column; position: relative; }
        
        /* 滚动条隐藏但可滚动 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 聊天背景 */
        .bg-pattern { background-image: url('https://web.telegram.org/img/bg_0.png'); background-repeat: repeat; background-attachment: fixed; }
        
        /* 安全区适配 */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* 启动页样式 */
        #splash-screen { position: fixed; inset: 0; background: #0f1621; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .glass-panel { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body oncontextmenu="return false">
    <div id="splash-screen">
        <div class="w-20 h-20 rounded-2xl bg-gradient-to-tr from-blue-600 to-cyan-500 flex items-center justify-center shadow-2xl animate-pulse-fast mb-4">
            <svg class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
        </div>
        <h2 class="text-white font-bold text-lg tracking-widest">汇盈加密专线</h2>
        <p class="text-gray-500 text-xs mt-2">安全 · 快速 · 私密</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const SOCKET_URL = "https://lt-1li6.onrender.com"; 
        
        // Key转换工具
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
            return outputArray;
        }

        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        let w = img.width, h = img.height; const maxSide = 1280; 
                        if (Math.max(w, h) > maxSide) { const scale = maxSide / Math.max(w, h); w *= scale; h *= scale; }
                        canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        };

        const IconStatus = ({ status }) => status === 'read' ? <span className="text-green-400 text-[10px] ml-1 font-bold">✓✓</span> : <span className="text-gray-500 text-[10px] ml-1">✓</span>;
        
        function App() {
            const [step, setStep] = useState('loading'); 
            const [loginInput, setLoginInput] = useState('');
            const [userId, setUserId] = useState('');
            const [bossId, setBossId] = useState('');
            const [messages, setMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [adminTyping, setAdminTyping] = useState(false);
            const [previewImg, setPreviewImg] = useState(null);
            
            // PWA 强引导状态
            const [installState, setInstallState] = useState({ show: false, type: null, prompt: null });
            
            const socketRef = useRef(null);
            const scrollRef = useRef(null);
            const typingTimeoutRef = useRef(null);

            // --- 核心：PWA 检测与拦截 ---
            useEffect(() => {
                // 移除启动页
                setTimeout(() => {
                    const splash = document.getElementById('splash-screen');
                    if(splash) { splash.style.opacity = '0'; setTimeout(()=>splash.remove(), 500); }
                }, 1500);

                // 注册 SW
                if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');

                // 检测是否已安装 (Standalone 模式)
                const isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
                
                if (!isStandalone) {
                    const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
                    if (isIos) {
                        // iOS 强引导
                        setInstallState({ show: true, type: 'ios', prompt: null });
                    } else {
                        // Android 监听安装事件
                        window.addEventListener('beforeinstallprompt', (e) => {
                            e.preventDefault();
                            setInstallState({ show: true, type: 'android', prompt: e });
                        });
                        // 如果没有触发事件（可能是已经关掉了或者不支持），也显示个通用提示
                        // setTimeout(() => setInstallState(prev => prev.show ? prev : { show: true, type: 'android', prompt: null }), 2000);
                    }
                }
            }, []);

            const handleInstall = () => {
                if (installState.prompt) {
                    installState.prompt.prompt();
                    installState.prompt.userChoice.then(res => {
                        if(res.outcome === 'accepted') setInstallState({ show: false, type: null, prompt: null });
                    });
                }
            };
            // ---------------------------

            const registerPush = async (uid) => {
                if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
                try {
                    const reg = await navigator.serviceWorker.ready;
                    let sub = await reg.pushManager.getSubscription();
                    if (!sub) {
                        const res = await fetch(`${SOCKET_URL}/api/vapid-key`);
                        const { publicKey } = await res.json();
                        if(!publicKey) return; 
                        sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(publicKey) });
                    }
                    await fetch(`${SOCKET_URL}/api/subscribe`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: uid, subscription: sub }) });
                } catch (e) {}
            };

            // 初始化逻辑
            useEffect(() => {
                const u = localStorage.getItem('hy_uid');
                const b = localStorage.getItem('hy_boss');
                
                // 点击页面任意位置解锁音频和推送
                const unlock = () => {
                    const a = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABBlYXRhAgAAAAEA"); a.play().catch(()=>{});
                    if("Notification" in window && Notification.permission !== "granted") Notification.requestPermission();
                    if(u) registerPush(u);
                };
                document.body.addEventListener('touchstart', unlock, { once: true });
                document.body.addEventListener('click', unlock, { once: true });

                if(u && b) doLogin(u, b); else setStep('login');
                
                // 页面可见性处理
                const handleVis = () => {
                    if (document.visibilityState === 'visible') {
                        if(socketRef.current?.connected === false) socketRef.current.connect();
                        if(u) {
                            fetchMessages(u);
                            registerPush(u); // 刷新订阅
                            if(socketRef.current) socketRef.current.emit('mark_read', { userId: u, isAdmin: false });
                        }
                    }
                };
                document.addEventListener('visibilitychange', handleVis);
                return () => document.removeEventListener('visibilitychange', handleVis);
            }, []);

            useEffect(() => scrollRef.current?.scrollIntoView({ behavior: "smooth" }), [messages, adminTyping]);

            const notify = () => { 
                try { const a = new Audio("data:audio/mp3;base64,SUQzBAAAAAABAFRYWFgAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFhYAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFhYAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAPAAADTGF2ZjU3LjgzLjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAABAAAAAAAAAAAAkJAAAgAAAABBjatLUkAAALiI1yUIAAAAAA//uQZAAABHpWUNzgAAIE6sobnAAACW1lS+w8AAiVrKl9h4AAAD/8z/8///4v/9P/8v8Z///4iH/////5MAAiAAACAAAAABAA8AAAAA//uQZAEABdZRVH5gAAl1lKU/mAAAggVlS+w8AAhxrKl9h4AAAAv///4DAAEAJgAOAFAAbAB8AIAAxADoAPABSAHAAgACWAKgArAC8AMQA0gDeAOwA+gEIAQwBGgEgASgBLAEyAToBQAFIAT4BRAFQAVgBXAFkAWgBcAF4AYABiAGMAZgBoAGoAbABuAHAAcgB0AHYAxQD9AP8BAQEDAv///wAAAAAA"); a.play().catch(()=>{}); if(navigator.vibrate) navigator.vibrate([200]); } catch(e){} 
            };
            
            const fetchMessages = (uid) => { fetch(`${SOCKET_URL}/api/history/${uid}`).then(r=>r.json()).then(d => { if(Array.isArray(d)) setMessages(d); }); };
            const doLogin = (uid, bid) => { setUserId(uid); setBossId(bid); setStep('chat'); initSocket(uid, bid); registerPush(uid); };

            const initSocket = (uid, bid) => {
                if (socketRef.current) return;
                socketRef.current = io(SOCKET_URL);
                socketRef.current.on('connect', () => socketRef.current.emit('join', { userId: uid, bossId: bid }));
                socketRef.current.on('receive_message', (msg) => {
                    setMessages(p => p.some(m => m.id === msg.id) ? p : [...p, msg]);
                    if(!msg.isFromUser) { notify(); setAdminTyping(false); if(document.visibilityState==='visible') socketRef.current.emit('mark_read', { userId: uid, isAdmin: false }); }
                });
                socketRef.current.on('message_deleted', ({ messageId }) => setMessages(p => p.filter(m => m.id !== messageId)));
                socketRef.current.on('display_typing', ({ isTyping }) => { setAdminTyping(isTyping); if(typingTimeoutRef.current) clearTimeout(typingTimeoutRef.current); if(isTyping) typingTimeoutRef.current = setTimeout(()=>setAdminTyping(false), 3000); });
                socketRef.current.on('messages_read_update', () => setMessages(p => p.map(m => m.isFromUser ? { ...m, status: 'read' } : m)));
                socketRef.current.on('force_logout', () => { localStorage.clear(); location.reload(); });
                fetchMessages(uid);
            };

            const handleLoginBtn = () => {
                if("Notification" in window) Notification.requestPermission();
                const input = loginInput.trim().toLowerCase().replace(/@/g, '');
                const validBosses = ['rrii8', 'iibb8']; 
                if (validBosses.includes(input)) { 
                    const finalBossId = '@' + input; 
                    const tempSocket = io(SOCKET_URL); 
                    tempSocket.emit('request_id', finalBossId, (newId) => { localStorage.setItem('hy_uid', newId); localStorage.setItem('hy_boss', finalBossId); tempSocket.disconnect(); doLogin(newId, finalBossId); }); 
                } else { alert("未找到该老板，请检查用户名"); }
            };
            
            const handleSend = () => { if(!chatInput.trim()) return; const m = { userId, bossId, content: chatInput, type: 'text', isFromUser: true, createdAt: new Date(), status: 'sent' }; setMessages(p=>[...p, m]); socketRef.current.emit('send_message', m); setChatInput(''); };
            const handleImg = async (e) => { const f=e.target.files[0]; if(!f)return; try{ const b64 = await compressImage(f); const m = { userId, bossId, content: b64, type: 'image', isFromUser: true, createdAt: new Date(), status: 'sent' }; setMessages(p=>[...p, m]); socketRef.current.emit('send_message', m); }catch(e){} e.target.value=''; };

            // --- 强引导 UI 渲染 ---
            const InstallOverlay = () => {
                if (!installState.show) return null;
                return (
                    <div className="fixed inset-0 z-[999] bg-black/90 backdrop-blur-md flex flex-col items-center justify-center p-6 text-center animate-slide-up">
                        <div className="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center mb-6 shadow-[0_0_30px_rgba(239,68,68,0.5)]">
                            <svg className="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                        </div>
                        <h2 className="text-2xl font-black text-white mb-2">严重安全警告</h2>
                        <p className="text-gray-300 text-sm mb-8 leading-relaxed">
                            为了保障您的聊天隐私及<span className="text-red-400 font-bold">接收离线消息</span>，必须安装加密专线App。
                            <br/><br/>
                            <span className="bg-red-500/20 text-red-400 px-2 py-1 rounded">不安装将导致消息丢失！</span>
                        </p>
                        
                        {installState.type === 'ios' ? (
                            <div className="bg-white/10 border border-white/20 p-4 rounded-xl w-full max-w-xs">
                                <p className="text-sm font-bold text-white mb-2">iOS 安装步骤：</p>
                                <div className="text-left text-xs text-gray-300 space-y-2">
                                    <p>1. 点击浏览器底部的 <span className="text-blue-400 font-bold">分享按钮</span> <svg className="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg></p>
                                    <p>2. 下滑找到并点击 <span className="text-white font-bold bg-gray-600 px-1 rounded">添加到主屏幕</span></p>
                                    <p>3. 点击右上角 <span className="text-blue-400 font-bold">添加</span></p>
                                </div>
                            </div>
                        ) : (
                            <button onClick={handleInstall} className="w-full max-w-xs bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95 text-lg">
                                立即安装 App
                            </button>
                        )}
                        <button onClick={() => setInstallState({show:false})} className="mt-6 text-gray-500 text-xs underline decoration-dotted">我已知晓风险，暂时跳过</button>
                    </div>
                );
            };

            if (step === 'login') return (
                <div className="h-full w-full bg-login-bg flex flex-col items-center justify-center px-8 relative">
                    <InstallOverlay />
                    <div className="w-full max-w-[340px]">
                        <div className="flex justify-center mb-8">
                            <div className="w-20 h-20 rounded-2xl bg-gradient-to-tr from-blue-600 to-cyan-500 flex items-center justify-center shadow-lg">
                                <span className="text-white font-black text-2xl">HY</span>
                            </div>
                        </div>
                        <h1 className="text-2xl font-black text-white text-center mb-1">汇盈加密专线</h1>
                        <p className="text-gray-500 text-center text-sm mb-10">Secure Direct Line</p>
                        <div className="space-y-5">
                            <div className="relative">
                                <span className="absolute left-4 top-4 text-gray-500">@</span>
                                <input type="text" value={loginInput} onChange={(e) => setLoginInput(e.target.value)} className="w-full bg-login-input border border-gray-700 focus:border-blue-500 rounded-xl py-4 pl-9 pr-4 text-white outline-none font-medium transition-colors" placeholder="输入老板TG号" />
                            </div>
                            <button onClick={handleLoginBtn} className="w-full bg-blue-600 active:bg-blue-700 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-blue-900/30">建立加密连接</button>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="h-full flex flex-col bg-tg-bg relative">
                    <InstallOverlay />
                    {/* 头部 - 增加 pt-safe 适配刘海 */}
                    <header className="safe-top bg-tg-header border-b border-white/5 shrink-0 z-20">
                        <div className="h-14 flex items-center justify-between px-4">
                            <div className="flex items-center gap-3">
                                <div className="w-9 h-9 rounded-full bg-gradient-to-tr from-blue-500 to-cyan-500 flex items-center justify-center text-white font-bold text-sm shadow-md">HY</div>
                                <div><h3 className="font-bold text-sm text-white">汇盈专线</h3><p className="text-[10px] text-green-400 flex items-center gap-1"><span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>加密传输中</p></div>
                            </div>
                            <button onClick={()=>setInstallState({show:true, type: /iphone|ipad/.test(navigator.userAgent.toLowerCase())?'ios':'android', prompt:installState.prompt})} className="bg-white/10 text-xs text-blue-300 px-3 py-1.5 rounded-full border border-white/10">App安装</button>
                        </div>
                    </header>
                    
                    {/* 聊天区域 - 修复滚动 */}
                    <div className="flex-1 overflow-y-auto bg-pattern p-4 space-y-4 no-scrollbar">
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex ${msg.isFromUser ? 'justify-end' : 'justify-start'} animate-slide-up`}>
                                <div className={`px-3 py-2.5 rounded-2xl text-[15px] shadow-sm max-w-[80%] break-words ${msg.isFromUser ? 'bg-tg-blue text-white rounded-tr-sm' : 'bg-tg-secondary text-white rounded-tl-sm'}`}>
                                    {msg.type === 'image' ? <img src={msg.content} className="rounded-lg max-w-full" onClick={()=>setPreviewImg(msg.content)}/> : <p className="whitespace-pre-wrap leading-relaxed">{msg.content}</p>}
                                    <div className="flex justify-end items-center gap-1 mt-1 opacity-60"><span className="text-[10px]">{new Date(msg.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>{msg.isFromUser && <IconStatus status={msg.status} />}</div>
                                </div>
                            </div>
                        ))}
                        {adminTyping && <div className="text-gray-500 text-xs ml-2 animate-pulse">对方正在输入...</div>}
                        <div ref={scrollRef} />
                    </div>
                    
                    {/* 底部输入框 - 增加 pb-safe 适配底部横条 */}
                    <div className="bg-tg-header border-t border-white/5 shrink-0 safe-bottom z-20">
                        <div className="p-3 flex gap-2 items-end">
                            <label className="p-2 text-gray-400 active:text-blue-500 transition-colors"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><input type="file" accept="image/*" className="hidden" onChange={handleImg} /></label>
                            <textarea rows="1" value={chatInput} onChange={e=>setChatInput(e.target.value)} className="flex-1 bg-black/20 text-white text-sm px-4 py-2.5 rounded-2xl outline-none border border-transparent focus:border-blue-500/30 transition-all resize-none" placeholder="发送消息..."></textarea>
                            <button onClick={handleSend} disabled={!chatInput.trim()} className="p-2.5 rounded-full bg-blue-600 text-white shadow-lg disabled:opacity-50 disabled:shadow-none active:scale-90 transition-all"><svg className="w-5 h-5 rotate-90" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg></button>
                        </div>
                    </div>

                    {previewImg && <div className="fixed inset-0 z-50 bg-black/95 flex items-center justify-center p-4" onClick={()=>setPreviewImg(null)}><img src={previewImg} className="max-w-full max-h-full rounded-lg shadow-2xl" /></div>}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
