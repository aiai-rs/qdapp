<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    
    <meta name="theme-color" content="#0f1621">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <title>æ±‡ç›ˆå›½é™…å®˜æ–¹å®¢æœ</title>
    
    <link href="https://cdn.staticfile.net/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        tg: { bg: "#0f1621", header: "#17212b", input: "#0e1621", blue: "#2b5278", secondary: "#182533", accent: "#0088cc", danger: "#ff5252", warning: "#fb8c00" },
                        login: { bg: "#0b1016", card: "#161d27", input: "#161e29", textMain: "#ffffff", textSub: "#3b82f6", textWarn: "#ef4444" }
                    },
                    animation: { 
                        'slide-up': 'slideUp 0.3s ease-out forwards', 
                        'slide-down-toast': 'slideDownToast 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite', 
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both'
                    },
                    keyframes: { 
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideDownToast: { '0%': { transform: 'translateY(-150%)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        html { background-color: #0f1621; height: 100%; }
        body { 
            background-color: #0f1621;
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; 
            overscroll-behavior: none; 
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            position: fixed; left: 0; top: 0; right: 0; bottom: 0;
        }
        :root { --app-height: 100%; }
        #root { 
            width: 100%; height: var(--app-height); 
            display: flex; flex-direction: column; position: relative; z-index: 1; 
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .ios-scroll { overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; flex: 1; }
        .pt-safe-header { padding-top: env(safe-area-inset-top); min-height: calc(env(safe-area-inset-top) + 56px); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .glass-btn { background: linear-gradient(90deg, #2563eb 0%, #1d4ed8 100%); box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
        .glass-btn:active { transform: scale(0.98); }
        #static-loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; items-align: center; text-align: center;
        }
    </style>
</head>
<body oncontextmenu="return false">
    <div id="root">
        <div id="static-loading" class="animate-pulse">
            <div class="w-16 h-16 rounded-2xl bg-gray-800 flex items-center justify-center mb-4 mx-4 shadow-xl">
                <span class="text-white font-bold text-xl">HY</span>
            </div>
            <p class="text-gray-500 text-xs">æ­£åœ¨å»ºç«‹å®‰å…¨è¿æ¥...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useLayoutEffect } = React;
        const SOCKET_URL = "https://lt-1li6.onrender.com"; 

        const useAppHeight = () => {
            const isIos = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            useLayoutEffect(() => {
                const setHeight = () => {
                    if (isIos && window.visualViewport) {
                        const h = window.visualViewport.height;
                        document.documentElement.style.setProperty('--app-height', `${h}px`);
                        window.scrollTo(0, 0); document.body.scrollTop = 0;
                    } else {
                        document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
                    }
                };
                setHeight();
                window.addEventListener('resize', setHeight);
                if (window.visualViewport) {
                    window.visualViewport.addEventListener('resize', setHeight);
                    if (isIos) window.visualViewport.addEventListener('scroll', () => { window.scrollTo(0, 0); document.body.scrollTop = 0; });
                }
                return () => {
                    window.removeEventListener('resize', setHeight);
                    if (window.visualViewport) window.visualViewport.removeEventListener('resize', setHeight);
                };
            }, [isIos]);
        };

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
            return outputArray;
        }

        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        let w = img.width, h = img.height; const maxSide = 1280; 
                        if (Math.max(w, h) > maxSide) { const scale = maxSide / Math.max(w, h); w *= scale; h *= scale; }
                        canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        };

        const IconStatus = ({ status }) => {
            if (status === 'sending') return <span className="text-gray-400 text-[10px] ml-1 animate-spin">âŸ³</span>;
            if (status === 'read') return <span className="text-green-400 text-[10px] ml-1 font-bold">âœ“âœ“</span>;
            return <span className="text-gray-400 text-[10px] ml-1">âœ“</span>;
        };
        
        const getWorkStatus = () => {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const cambodiaTime = new Date(utc + (3600000 * 7));
            const hour = cambodiaTime.getHours();
            const isWorking = hour >= 13 && hour < 23; 
            return { isWorking, text: isWorking ? 'ä¸šåŠ¡å‘˜åœ¨çº¿' : 'ä¼‘æ¯ä¸­ (è¯·ç•™è¨€)', color: isWorking ? 'text-green-400' : 'text-tg-warning' };
        };

        const TopToast = ({ msg, show }) => {
            if (!show) return null;
            return (
                <div className="fixed top-4 left-4 right-4 z-[999] pointer-events-none animate-slide-down-toast">
                    <div className="bg-black/85 backdrop-blur-md border border-white/10 text-white px-4 py-3 rounded-2xl shadow-2xl flex items-center gap-3">
                        <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-green-500 to-green-600 flex items-center justify-center shrink-0 text-xs font-bold">HY</div>
                        <div className="flex-1 min-w-0">
                            <p className="font-bold text-sm text-gray-200">æ–°æ¶ˆæ¯</p>
                            <p className="text-xs text-white truncate">{msg}</p>
                        </div>
                    </div>
                </div>
            );
        };

        const LoadingView = () => (
            <div className="flex flex-col items-center justify-center h-full w-full bg-[#0f1621] animate-pulse">
                <div className="w-16 h-16 rounded-2xl bg-gray-800 flex items-center justify-center mb-4 shadow-xl">
                    <span className="text-white font-bold text-xl">HY</span>
                </div>
                <p className="text-gray-500 text-xs">æ­£åœ¨å»ºç«‹å®‰å…¨è¿æ¥...</p>
            </div>
        );

        function App() {
            useAppHeight(); 

            const isAndroid = /Android/i.test(navigator.userAgent);
            const isIos = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
            
            const [step, setStep] = useState('loading'); 
            const [loginInput, setLoginInput] = useState('');
            const [recoverId, setRecoverId] = useState('');
            const [showRecover, setShowRecover] = useState(false);
            const [loading, setLoading] = useState(false);
            
            const [userId, setUserId] = useState('');
            const [bossId, setBossId] = useState('');
            const [messages, setMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [errorMsg, setErrorMsg] = useState('');
            const [isShake, setIsShake] = useState(false);
            
            const [workStatus, setWorkStatus] = useState(getWorkStatus());
            const [previewImg, setPreviewImg] = useState(null);
            const [adminTyping, setAdminTyping] = useState(false);
            const [showTutorial, setShowTutorial] = useState(false);
            
            const [toast, setToast] = useState({ show: false, msg: '' });
            const toastTimer = useRef(null);
            
            const [installPrompt, setInstallPrompt] = useState(null); 
            const [canInstall, setCanInstall] = useState(false);
            const [showIosGuide, setShowIosGuide] = useState(false);
            const [showAndroidGuide, setShowAndroidGuide] = useState(false);

            // ä¿®æ”¹ï¼šæ–°å¢ä¸€ä¸ªçŠ¶æ€ï¼Œç”¨äºæ§åˆ¶æ˜¯å¦æ˜¾ç¤ºâ€œå»ºè®®å®‰è£…APPâ€çš„å¼¹çª—
            const [showInstallHint, setShowInstallHint] = useState(false);
            
            const socketRef = useRef(null);
            const messagesEndRef = useRef(null);
            const typingTimeoutRef = useRef(null);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const linkUid = params.get('uid');
                const linkBoss = params.get('boss'); 

                if (linkUid) localStorage.setItem('hy_uid', linkUid);
                if (linkBoss) localStorage.setItem('hy_boss', linkBoss);

                if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); setInstallPrompt(e); setCanInstall(true); });
                
                const timer = setInterval(() => setWorkStatus(getWorkStatus()), 60000);
                
                const savedId = localStorage.getItem('hy_uid');
                const savedBoss = localStorage.getItem('hy_boss');
                const targetId = linkUid || savedId;
                const targetBoss = linkBoss || savedBoss;

                if (targetId && targetBoss) {
                    setTimeout(() => doLogin(targetId, targetBoss), 300);
                } 
                else if (targetId) {
                    setUserId(targetId); setRecoverId(targetId); setStep('login'); 
                } else {
                    setStep('login');
                }
                
                return () => clearInterval(timer);
            }, []);

            // ä¿®æ”¹ï¼šæ–°å¢ useEffectï¼Œå½“ç”¨æˆ·è¿›å…¥ç•Œé¢ä¸”ä¸æ˜¯APPæ¨¡å¼(isStandaloneä¸ºfalse)æ—¶ï¼Œå¼¹å‡ºæç¤º
            useEffect(() => {
                if (!isStandalone) {
                    // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹æ˜¾ç¤ºï¼Œé¿å…å’ŒåŠ è½½ç”»é¢å†²çª
                    setTimeout(() => setShowInstallHint(true), 1500);
                }
            }, [isStandalone]);

            useEffect(() => {
                if (userId && bossId && isIos) {
                    const newUrl = new URL(window.location);
                    const currentUid = newUrl.searchParams.get('uid');
                    const currentBoss = newUrl.searchParams.get('boss');
                    if (currentUid !== userId || currentBoss !== bossId) {
                        newUrl.searchParams.set('uid', userId);
                        newUrl.searchParams.set('boss', bossId);
                        window.history.replaceState(null, '', newUrl.toString());
                    }
                }
            }, [userId, bossId, isIos]);

            const handleInstallAction = () => {
                requestNotificationPermission(); // ç‚¹å‡»æ—¶å¼ºåˆ¶è¯·æ±‚æƒé™
                if (isIos) setShowIosGuide(true);
                else if (canInstall && installPrompt) {
                    installPrompt.prompt();
                    installPrompt.userChoice.then((res) => { if (res.outcome === 'accepted') setCanInstall(false); setInstallPrompt(null); });
                } else setShowAndroidGuide(true);
            };

            const triggerToast = (content) => {
                const txt = content.startsWith('data:') || content.startsWith('blob:') ? '[å›¾ç‰‡]' : content;
                setToast({ show: true, msg: txt });
                if (toastTimer.current) clearTimeout(toastTimer.current);
                toastTimer.current = setTimeout(() => setToast({ show: false, msg: '' }), 3000);
            };

            const registerPush = async (uid) => {
                if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
                try {
                    const reg = await navigator.serviceWorker.ready;
                    let sub = await reg.pushManager.getSubscription();
                    if (!sub) {
                        const res = await fetch(`${SOCKET_URL}/api/vapid-key`);
                        const { publicKey } = await res.json();
                        if(!publicKey) return;
                        sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(publicKey) });
                    }
                    await fetch(`${SOCKET_URL}/api/subscribe`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: uid, subscription: sub }) });
                } catch (e) {}
            };

            const requestNotificationPermission = async () => {
                if (!('Notification' in window)) return;
                const permission = await Notification.requestPermission();
                if (permission === 'granted') { registerPush(userId); }
            };

            useEffect(() => {
                const unlockAudio = () => { const a = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABBlYXRhAgAAAAEA"); a.play().catch(()=>{}); };
                document.body.addEventListener('click', unlockAudio, { once: true });
                document.body.addEventListener('touchstart', unlockAudio, { once: true });
            }, [userId]);

            const flashTitle = (start) => { if (start) { document.title = "ã€ğŸ”” æ–°æ¶ˆæ¯ã€‘æ±‡ç›ˆå›½é™…"; } else { document.title = "æ±‡ç›ˆå›½é™…å®˜æ–¹å®¢æœ"; } };

            useEffect(() => {
                const handleVisibility = () => {
                    if (document.visibilityState === 'visible') {
                        flashTitle(false);
                        const u = localStorage.getItem('hy_uid');
                        if(socketRef.current?.connected === false) socketRef.current.connect();
                        if(u) { fetchMessages(u); registerPush(u); if(socketRef.current) socketRef.current.emit('mark_read', { userId: u, isAdmin: false }); }
                    }
                };
                document.addEventListener('visibilitychange', handleVisibility);
                return () => document.removeEventListener('visibilitychange', handleVisibility);
            }, []);

            useEffect(() => { if (messagesEndRef.current) messagesEndRef.current.scrollIntoView({ behavior: "smooth" }); }, [messages, adminTyping, step]);

            const fetchMessages = (uid) => { fetch(`${SOCKET_URL}/api/history/${uid}`).then(r=>r.json()).then(d => { if(Array.isArray(d)) setMessages(d); }); };
            
            const doLogin = (uid, bid) => { 
                if(socketRef.current) socketRef.current.disconnect(); 
                setUserId(uid); setBossId(bid); setStep('chat'); 
                localStorage.setItem('hy_uid', uid);
                localStorage.setItem('hy_boss', bid);
                initSocket(uid, bid); 
                registerPush(uid); 
            };
            
            const forceLogoutNow = (reason) => {
                localStorage.removeItem('hy_uid'); // æ˜ç¡®åˆ é™¤ç¼“å­˜
                localStorage.removeItem('hy_boss'); // æ˜ç¡®åˆ é™¤ç¼“å­˜
                localStorage.clear(); // æ¸…ç©ºæ‰€æœ‰
                setMessages([]); 
                setUserId(''); 
                setBossId(''); // ç¡®ä¿çŠ¶æ€ä¹Ÿè¢«é‡ç½®
                setStep('login'); 
                if(socketRef.current) socketRef.current.disconnect();
                // å…³é”®ä¿®æ­£ï¼šä½¿ç”¨ replaceState æ¸…é™¤ URL å‚æ•°è€Œä¸åˆ·æ–°é¡µé¢ï¼Œé˜²æ­¢åˆ·æ–°åæ­»å¾ªç¯é‡æ–°ç™»å½•
                window.history.replaceState(null, '', window.location.pathname);
                if(reason) setErrorMsg(reason); // ä½¿ç”¨ UI é”™è¯¯æç¤ºä»£æ›¿ alertï¼Œä½“éªŒæ›´å¥½
            };

            const initSocket = (uid, bid) => {
                try {
                    socketRef.current = io(SOCKET_URL);
                    socketRef.current.on('connect', () => socketRef.current.emit('join', { userId: uid, bossId: bid }));
                    
                    socketRef.current.on('receive_message', (msg) => {
                        setMessages(prev => { if (prev.some(m => m.id === msg.id)) return prev; return [...prev, msg]; });
                        if(!msg.isFromUser) { 
                            triggerToast(msg.content); 
                            try { 
                                const a = new Audio("data:audio/mp3;base64,SUQzBAAAAAABAFRYWFgAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFhYAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFhYAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAPAAADTGF2ZjU3LjgzLjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAABAAAAAAAAAAAAkJAAAgAAAABBjatLUkAAALiI1yUIAAAAAA//uQZAAABHpWUNzgAAIE6sobnAAACW1lS+w8AAiVrKl9h4AAAD/8z/8///4v/9P/8v8Z///4iH/////5MAAiAAACAAAAABAA8AAAAA//uQZAEABdZRVH5gAAl1lKU/mAAAggVlS+w8AAhxrKl9h4AAAAv///4DAAEAJgAOAFAAbAB8AIAAxADoAPABSAHAAgACWAKgArAC8AMQA0gDeAOwA+gEIAQwBGgEgASgBLAEyAToBQAFIAT4BRAFQAVgBXAFkAWgBcAF4AYABiAGMAZgBoAGoAbABuAHAAcgB0AHYAxQD9AP8BAQEDAv///wAAAAAA"); a.play().catch(()=>{}); 
                                if(navigator.vibrate) navigator.vibrate([200]); 
                                
                                // ç³»ç»Ÿå¼¹çª—é€šçŸ¥ (è¿™å°±æ˜¯åº”ç”¨å¤–çš„å¼¹çª—)
                                if (Notification.permission === 'granted' && document.hidden) {
                                    new Notification("æ±‡ç›ˆå›½é™… - æ–°æ¶ˆæ¯", { body: msg.content.startsWith('data:') ? '[å›¾ç‰‡]' : msg.content, icon: '/icon-192.png' });
                                }
                            } catch(e){} 
                            if(document.hidden) flashTitle(true);
                            setAdminTyping(false);
                            if (document.visibilityState === 'visible') socketRef.current.emit('mark_read', { userId: uid, isAdmin: false }); 
                        }
                    });
                    
                    socketRef.current.on('message_deleted', ({ messageId }) => setMessages(prev => prev.filter(m => m.id !== messageId)));
                    socketRef.current.on('display_typing', ({ isTyping }) => { 
                        setAdminTyping(isTyping); 
                        if(typingTimeoutRef.current) clearTimeout(typingTimeoutRef.current);
                        if(isTyping) typingTimeoutRef.current = setTimeout(()=>setAdminTyping(false), 3000);
                    });
                    
                    // ä¿®å¤ï¼šåå°åˆå¹¶åï¼Œè§¦å‘æ­¤äº‹ä»¶ï¼Œå‰ç«¯è‡ªåŠ¨åˆ·æ–°å†å²æ¶ˆæ¯
                    socketRef.current.on('messages_read_update', () => {
                        fetchMessages(uid); 
                    });
                    
                    socketRef.current.on('force_logout', () => forceLogoutNow("âš ï¸ æ‚¨çš„ä¼šè¯å·²ç»“æŸ"));
                    socketRef.current.on('force_logout_blocked', () => forceLogoutNow("ğŸš« æ‚¨å·²è¢«ç®¡ç†å‘˜é™åˆ¶è®¿é—®"));
                    socketRef.current.on('admin_user_blocked', () => forceLogoutNow("ğŸš« æ‚¨å·²è¢«ç®¡ç†å‘˜é™åˆ¶è®¿é—®"));
                    
                    // ä¿®æ”¹ï¼šå°†æ¸…ç©º/é‡ç½®äº‹ä»¶ä¹Ÿç»‘å®šåˆ°å¼ºåˆ¶ç™»å‡ºï¼Œå¹¶ä¿®æ”¹æç¤ºæ–‡æ¡ˆ
                    socketRef.current.on('admin_db_cleared', () => forceLogoutNow("âš ï¸ èŠå¤©è®°å½•å·²æ¸…ç©ºï¼Œè¯·é‡æ–°ç™»å½•"));
                    socketRef.current.on('history_cleared', () => forceLogoutNow("âš ï¸ èŠå¤©è®°å½•å·²æ¸…ç©ºï¼Œè¯·é‡æ–°ç™»å½•"));

                    fetch(`${SOCKET_URL}/api/history/${uid}`).then(r=>r.json()).then(d => { if(Array.isArray(d)) setMessages(d); });
                } catch (e) {}
            };

            const handleLoginBtn = () => { 
                requestNotificationPermission(); // ç™»å½•æ—¶ä¹Ÿè¯·æ±‚ä¸€æ¬¡æƒé™
                setErrorMsg(''); setLoading(true);
                
                if (showRecover) {
                    const rid = recoverId.trim();
                    if (!rid) { setErrorMsg('è¯·è¾“å…¥æ—§ ID'); setLoading(false); return; }
                    fetch(`${SOCKET_URL}/api/user/check`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: rid }) }).then(r => r.json()).then(data => {
                        setLoading(false);
                        if (data.exists) doLogin(rid, '@SystemRestore');
                        else setErrorMsg('ID ä¸å­˜åœ¨');
                    }).catch(() => { setLoading(false); setErrorMsg('ç½‘ç»œè¿æ¥å¤±è´¥'); });
                    return;
                }

                const input = loginInput.trim().toLowerCase().replace(/@/g, ''); 
                if(!input) { setErrorMsg('è¯·è¾“å…¥ç”¨æˆ·å'); setLoading(false); return; }

                // ç§»é™¤è€æ¿ç™½åå•é™åˆ¶ï¼Œå…è®¸è¿æ¥ä»»ä½•è€æ¿
                const tempSocket = io(SOCKET_URL); 
                tempSocket.emit('request_id', '@'+input, (newId) => { 
                    tempSocket.disconnect(); setLoading(false); 
                    doLogin(newId, '@'+input); 
                }); 
            };
            
            const handleTyping = (e) => { 
                setChatInput(e.target.value); 
                if(socketRef.current) socketRef.current.emit('typing', { targetId: 'admin', isTyping: true });
            };

            const handleSend = () => { 
                if (!chatInput.trim()) return; 
                const msgData = { userId, content: chatInput, type: 'text', isFromUser: true, createdAt: new Date(), status: 'sent', bossId }; 
                socketRef.current.emit('send_message', msgData); 
                socketRef.current.emit('typing', { targetId: 'admin', isTyping: false });
                setChatInput(''); 
            };
            
            const handleImageUpload = async (e) => { 
                const file = e.target.files[0]; 
                if (!file) return; 
                const previewUrl = URL.createObjectURL(file);
                const tempId = Date.now();
                const tempMsg = { id: tempId, userId, content: previewUrl, type: 'image', isFromUser: true, status: 'sending', createdAt: new Date(), bossId };
                setMessages(prev => [...prev, tempMsg]);
                e.target.value = ''; 
                setTimeout(async () => {
                    try { 
                        const base64 = await compressImage(file);
                        socketRef.current.emit('send_message', { ...tempMsg, content: base64, bossId });
                        setMessages(prev => prev.map(m => m.id === tempId ? { ...m, status: 'sent' } : m));
                    } catch(e) { alert("å›¾ç‰‡å¤„ç†å¤±è´¥"); setMessages(prev => prev.filter(m => m.id !== tempId)); } 
                }, 10);
            };

            const GuideModal = ({ title, children, onClose }) => (
                <div className="fixed inset-0 bg-black/80 z-[1000] flex items-end justify-center pb-8" onClick={onClose}>
                    <div className="bg-[#17212b] border border-gray-700 p-5 rounded-2xl max-w-sm w-full mx-4 animate-slide-up text-center shadow-2xl" onClick={e=>e.stopPropagation()}>
                        <div className="flex items-center justify-center gap-2 mb-3">
                            <span className="text-xl">ğŸ””</span>
                            <p className="text-white font-bold text-lg">{title}</p>
                        </div>
                        {userId && (
                            <div className="bg-blue-900/20 border border-blue-500/30 p-3 rounded-lg mb-4 text-left">
                                <p className="text-blue-400 text-xs mb-1">æ‚¨çš„ ID: <span className="text-white font-mono font-bold select-all text-sm">{userId}</span></p>
                                <p className="text-blue-400 text-xs">å½“å‰è€æ¿: <span className="text-white font-mono font-bold select-all text-sm">{bossId}</span></p>
                                <p className="text-gray-400 text-[10px] mt-1 pt-1 border-t border-white/10">æˆªå›¾æ­¤ç”»é¢ã€‚è‹¥APPèŠå¤©è®°å½•ä¸¢å¤±ï¼Œå‘é€æ­¤IDç»™å®¢æœå¯æ‰¾å›ã€‚</p>
                            </div>
                        )}
                        <div className="text-left text-xs text-gray-300 space-y-3 mb-5 bg-black/30 p-4 rounded-xl">{children}</div>
                        <button onClick={onClose} className="w-full bg-[#2b5278] hover:bg-[#254666] text-white font-bold py-3 rounded-xl transition-colors">æˆ‘çŸ¥é“äº†</button>
                    </div>
                </div>
            );

            if (step === 'loading') return <LoadingView />;

            if (step === 'login') return (
                <div className="flex flex-col justify-center px-8 relative font-sans w-full bg-login-bg h-full">
                    <div className="z-10 w-full max-w-[340px] mx-auto">
                        <h1 className="text-[34px] font-black text-white mb-2">æ±‡ç›ˆå›½é™…å®˜æ–¹å®¢æœ</h1>
                        <p className="text-gray-400 text-[15px] mb-8 font-medium">è¯·è¾“å…¥å¹¿å‘Šä¸­è€æ¿çš„ <span className="text-login-textSub font-bold">Telegram ç”¨æˆ·å</span></p>
                        <div className="mb-6 flex items-start gap-2.5">
                            <span className="text-yellow-500 text-sm mt-0.5">âš ï¸</span>
                            <span className="text-login-textWarn text-[13px] font-bold leading-tight tracking-wide">è€æ¿ä»…ç”¨ Telegramï¼Œè¯·åŠ¡å¿…è”ç³»ä¸šåŠ¡å‘˜ï¼Œä¸šåŠ¡å‘˜ä¼šæ•™ä½ ä½¿ç”¨Telegramæ¥ä¸è€æ¿è”ç³»</span>
                        </div>
                        <div className="space-y-6">
                            {!showRecover && (
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><span className="text-gray-500 font-bold text-lg select-none">@</span></div>
                                    <input type="text" value={loginInput} onChange={(e) => setLoginInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleLoginBtn()} className="w-full bg-login-input border border-gray-800 focus:border-blue-600 focus:ring-1 focus:ring-blue-600/50 rounded-xl py-4 pl-10 pr-4 text-white outline-none transition-all placeholder-gray-500 text-[16px] shadow-sm font-medium" placeholder="è¾“å…¥å¹¿å‘Šä¸­è€æ¿çš„TGç”¨æˆ·å" />
                                </div>
                            )}
                            {showRecover && (
                                <div className="relative group animate-fade-in">
                                    <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><span className="text-gray-500 text-lg">ğŸ†”</span></div>
                                    <input type="text" value={recoverId} onChange={(e) => setRecoverId(e.target.value)} className="w-full bg-login-input border border-gray-700 focus:border-blue-600 rounded-xl py-4 pl-10 pr-4 text-white outline-none" placeholder="è¾“å…¥æ—§ID (ç½‘é¡µçš„appæŒ‰é”®é‡Œæœ‰æ˜¾ç¤º)" />
                                </div>
                            )}
                            <div className="min-h-[24px]">{errorMsg && (<div className={`text-login-textWarn text-[13px] font-bold flex items-center gap-1.5 ${isShake ? 'animate-shake' : ''}`}>{errorMsg}</div>)}</div>
                            <button onClick={handleLoginBtn} disabled={loading} className="w-full glass-btn text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 transition-all text-[16px] tracking-wide disabled:opacity-50">
                                {loading ? 'Checking...' : (showRecover ? 'æ¢å¤æ—§è´¦å·' : 'è¿æ¥æ±‡ç›ˆå›½é™…å®˜æ–¹ä¸šåŠ¡å‘˜')} <span className="text-xl leading-none mb-0.5 ml-1">â†’</span>
                            </button>
                            {recoverId && !showRecover && <div className="text-center text-gray-500 text-xs mt-2 bg-white/5 p-2 rounded">å½“å‰ ID: <span className="text-white font-mono font-bold select-all">{recoverId}</span> (å®‰è£… App åå¯ç”¨æ­¤ ID æ‰¾å›)</div>}
                            <div className="flex justify-between items-center pt-2">
                                <button onClick={handleInstallAction} className="text-blue-300/80 text-xs flex items-center gap-1 hover:text-white border border-blue-500/30 bg-blue-500/5 px-3 py-1.5 rounded-full transition-all active:scale-95">
                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                                    {canInstall ? "ğŸ“² ä¸€é”®å®‰è£…APP" : "ğŸ“² å¼€å¯ç¦»çº¿é€šçŸ¥"}
                                </button>
                                {!isAndroid && (
                                    <button onClick={() => setShowRecover(!showRecover)} className="text-gray-500 text-xs hover:text-gray-300 underline decoration-dotted">
                                        {showRecover ? 'è¿”å›æ³¨å†Œ' : 'æ‰¾å›æ—§è´¦å·?'}
                                    </button>
                                )}
                            </div>
                            <div className="text-center pt-2 opacity-60">
                                <p className="text-indigo-200 text-[12px] font-medium tracking-wide flex items-center justify-center gap-1.5">
                                    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    ä¸šåŠ¡å‘˜ä¸Šç­æ—¶é—´: 13:00 - 23:00
                                </p>
                            </div>
                        </div>
                    </div>
                    {showIosGuide && <GuideModal title="å®‰è£…åˆ° iPhone" onClose={()=>setShowIosGuide(false)}><p>1. ç‚¹å‡»ä¸‹æ–¹ <span className="text-blue-400 font-bold">åˆ†äº«æŒ‰é’®</span> <svg className="w-3.5 h-3.5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg></p><p>2. ä¸‹æ»‘é€‰æ‹© <span className="text-white font-bold bg-gray-600 px-1 rounded">æ·»åŠ åˆ°ä¸»å±å¹•</span></p><p>3. ä»¥åè¯·ä»æ¡Œé¢å›¾æ ‡æ‰“å¼€</p></GuideModal>}
                    {showAndroidGuide && <GuideModal title="å®‰è£…åˆ°å®‰å“/ç”µè„‘" onClose={()=>setShowAndroidGuide(false)}><p>1. ç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’ <span className="text-white font-bold">èœå• (â‹®)</span></p><p>2. é€‰æ‹© <span className="text-white font-bold">å®‰è£…åº”ç”¨</span> æˆ– <span className="text-white font-bold">æ·»åŠ åˆ°ä¸»å±å¹•</span></p></GuideModal>}
                    
                    {/* ä¿®æ”¹ï¼šåœ¨ Login ç•Œé¢ä¹Ÿæ·»åŠ è¿™ä¸ªå¼¹çª— */}
                    {showInstallHint && (
                        <GuideModal title="âš ï¸ æ¶ˆæ¯é˜²ä¸¢æé†’" onClose={() => setShowInstallHint(false)}>
                            <p className="text-white text-sm">å»ºè®®å®‰è£…APPæ¥æ¥æ”¶ä¸šåŠ¡å‘˜çš„å›å¤ï¼Œé¿å…é€šçŸ¥æ”¶ä¸åˆ°ã€‚</p>
                            <button onClick={() => { setShowInstallHint(false); handleInstallAction(); }} className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded-lg mt-3 transition-colors">
                                ğŸ“² ç«‹å³å®‰è£…APP
                            </button>
                        </GuideModal>
                    )}
                </div>
            );

            return (
                <div className="flex flex-col w-full h-full bg-tg-bg">
                    <TopToast msg={toast.msg} show={toast.show} />
                    <header className="w-full bg-tg-header text-white pt-safe-header flex-shrink-0 z-50 border-b border-white/5 flex items-center justify-between px-4 shadow-md">
                        <div className="flex items-center gap-3">
                            <div className="w-9 h-9 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-sm">HY</div>
                            <div>
                                <h3 className="font-bold text-sm">æ±‡ç›ˆå›½é™…å®˜æ–¹å®¢æœ</h3>
                                <p className={`text-[10px] ${workStatus.color}`}>{workStatus.text}</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            {isIos && isStandalone && Notification.permission === 'default' && (
                                <button onClick={requestNotificationPermission} className="bg-green-600/20 text-green-400 text-xs px-3 py-1.5 rounded-full border border-green-500/30 animate-pulse">å¼€å¯é€šçŸ¥</button>
                            )}
                            {!isStandalone && <button onClick={handleInstallAction} className="bg-white/5 hover:bg-white/10 text-blue-300 text-xs px-3 py-1.5 rounded-full border border-blue-500/30">APP</button>}
                            <button onClick={() => setShowTutorial(true)} className="bg-white/5 hover:bg-white/10 text-tg-accent text-xs px-3 py-1.5 rounded-full border border-tg-accent/30">æ•™ç¨‹</button>
                        </div>
                    </header>

                    <div className="ios-scroll p-4 space-y-3 bg-transparent">
                        <div className="text-center py-2 animate-fade-in">
                            <p className="text-gray-400 text-xs bg-black/20 inline-block px-3 py-1.5 rounded-full cursor-pointer hover:bg-black/30 transition-colors border border-white/5" onClick={isStandalone ? requestNotificationPermission : handleInstallAction}>
                                ğŸ”” {isStandalone ? "ç‚¹æ­¤å…è®¸æ¥æ”¶ã€Œç¦»çº¿æ¶ˆæ¯ã€é€šçŸ¥" : "ç‚¹æ­¤å¼€å¯ã€Œç¦»çº¿é€šçŸ¥ã€ï¼Œé¿å…æ”¶ä¸åˆ°å›å¤ >"}
                            </p>
                        </div>
                        {messages.length===0 && <div className="text-center text-gray-500 text-xs mt-4">æ­£åœ¨å»ºç«‹åŠ å¯†è¿æ¥...</div>}
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex ${msg.isFromUser ? 'justify-end' : 'justify-start'} animate-slide-up`}>
                                <div className={`px-3 py-2.5 rounded-2xl text-sm max-w-[260px] break-words ${msg.isFromUser ? 'bg-tg-blue text-white rounded-tr-sm' : 'bg-tg-secondary text-white rounded-tl-sm'}`}>
                                    {(msg.type === 'image' || msg.content.startsWith('data:') || msg.content.startsWith('blob:')) ? 
                                        <img src={msg.content} className="max-w-[200px] rounded-lg" onClick={() => setPreviewImg(msg.content)} /> 
                                        : msg.content
                                    }
                                    <div className="flex justify-end items-center gap-1 mt-1"><span className="text-[10px] opacity-50">{new Date(msg.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>{msg.isFromUser && <IconStatus status={msg.status} />}</div>
                                </div>
                            </div>
                        ))}
                        {adminTyping && <div className="bg-tg-secondary px-3 py-2 rounded-xl w-12 flex gap-1 ml-1 mb-2"><div className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></div><div className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style={{animationDelay:'0.1s'}}></div><div className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style={{animationDelay:'0.2s'}}></div></div>}
                        <div ref={messagesEndRef} />
                    </div>

                    <div className="bg-tg-header p-3 pb-safe border-t border-white/5 shrink-0 flex gap-2 items-center">
                        <label className="text-gray-400 p-2"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><input type="file" accept="image/*" className="hidden" onChange={handleImageUpload} /></label>
                        <textarea id="chat-input" rows="1" value={chatInput} onChange={handleTyping} onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSend())} className="flex-1 bg-black/20 rounded-lg text-white text-sm p-2 outline-none border border-transparent focus:border-blue-500/50 transition-all resize-none" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
                        <button onClick={handleSend} className="p-2 px-4 rounded-xl text-white bg-tg-accent font-bold text-sm shadow-lg">å‘é€</button>
                    </div>
                    
                    {previewImg && <div className="fixed inset-0 z-[2000] flex items-center justify-center bg-black/95 backdrop-blur-md" onClick={() => setPreviewImg(null)}><img src={previewImg} className="max-w-screen max-h-screen object-contain" /></div>}
                    
                    {showTutorial && (
                        <div className="fixed inset-0 z-[1500] flex items-center justify-center bg-black/80 backdrop-blur-sm px-6" onClick={() => setShowTutorial(false)}>
                            <div className="w-full max-w-sm bg-tg-header rounded-2xl border border-gray-700 overflow-hidden shadow-2xl p-5" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold text-white mb-4">ğŸš€ å¿«é€Ÿæ•™ç¨‹</h3>
                                <p className="text-gray-300 text-sm mb-4">1. è·å–ç¾åŒº Apple IDï¼ˆè”ç³»ä¸šåŠ¡å‘˜è·å–ï¼‰<br/>2. ä¸‹è½½ Shadowrocketï¼ˆè”ç³»ä¸šåŠ¡å‘˜è·å–ï¼‰<br/>3. å¤åˆ¶é“¾æ¥æ‰“å¼€ï¼ˆè”ç³»ä¸šåŠ¡å‘˜è·å–ï¼‰</p>
                                <button onClick={() => setShowTutorial(false)} className="w-full bg-tg-accent text-white py-2 rounded">å…³é—­</button>
                            </div>
                        </div>
                    )}
                    
                    {showIosGuide && <GuideModal title="å®‰è£…åˆ° iPhone" onClose={()=>setShowIosGuide(false)}><p>1. ç‚¹å‡»ä¸‹æ–¹ <span className="text-blue-400 font-bold">åˆ†äº«æŒ‰é’®</span> <svg className="w-3.5 h-3.5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg></p><p>2. ä¸‹æ»‘é€‰æ‹© <span className="text-white font-bold bg-gray-600 px-1 rounded">æ·»åŠ åˆ°ä¸»å±å¹•</span></p><p>3. ä»¥åè¯·ä»æ¡Œé¢å›¾æ ‡æ‰“å¼€</p></GuideModal>}
                    {showAndroidGuide && <GuideModal title="å®‰è£…åˆ°å®‰å“/ç”µè„‘" onClose={()=>setShowAndroidGuide(false)}><p>1. ç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’ <span className="text-white font-bold">èœå• (â‹®)</span></p><p>2. é€‰æ‹© <span className="text-white font-bold">å®‰è£…åº”ç”¨</span> æˆ– <span className="text-white font-bold">æ·»åŠ åˆ°ä¸»å±å¹•</span></p></GuideModal>}
                    
                    {/* ä¿®æ”¹ï¼šåœ¨ Chat ç•Œé¢ä¹Ÿæ·»åŠ è¿™ä¸ªå¼¹çª— */}
                    {showInstallHint && (
                        <GuideModal title="âš ï¸ æ¶ˆæ¯é˜²ä¸¢æé†’" onClose={() => setShowInstallHint(false)}>
                            <p className="text-white text-sm">å»ºè®®å®‰è£…APPæ¥æ¥æ”¶ä¸šåŠ¡å‘˜çš„å›å¤ï¼Œé¿å…é€šçŸ¥æ”¶ä¸åˆ°ã€‚</p>
                            <button onClick={() => { setShowInstallHint(false); handleInstallAction(); }} className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded-lg mt-3 transition-colors">
                                ğŸ“² ç«‹å³å®‰è£…APP
                            </button>
                        </GuideModal>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        document.addEventListener('keydown',function(e){if(e.key==='F12'||(e.ctrlKey&&e.shiftKey&&(e.key==='I'||e.key==='J'||e.key==='C'))||(e.ctrlKey&&(e.key==='s'||e.key==='S'))||(e.ctrlKey&&(e.key==='u'||e.key==='U'))||(e.ctrlKey&&(e.key==='l'||e.key==='L'))){e.preventDefault();return false;}});
    </script>
</body>
</html>
